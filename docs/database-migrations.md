## Database migrations (Drizzle + Cloudflare D1)

This guide explains how to organize, generate, and apply schema changes.

### Folder layout

- Schema definitions: `backend/drizzle/schema/*`
- Drizzle config: `backend/drizzle.config.ts` (points to the schema aggregator and outputs migrations to `backend/drizzle/migrations`)
- Migration files: `backend/drizzle/migrations/*.sql` and `backend/drizzle/migrations/meta/*`
- Wrangler D1 is configured to read migrations from `backend/drizzle/migrations` via `backend/wrangler.toml`

### Common tasks

1. Make a schema change

- Edit or add table definitions in `backend/drizzle/schema/*` (modular files)
- Export them from `backend/drizzle/schema/index.ts` if new

2. Generate migrations

```bash
yarn --cwd backend db:generate
```

This will diff the current schema and write SQL migrations into `backend/drizzle/migrations/`.

3. Apply all pending migrations locally

```bash
yarn --cwd backend db:migrate:apply
```

This uses Wrangler to apply all SQL files in order to the local D1 database.

4. Apply a single migration file (advanced)
   If you need to apply a specific SQL file manually:

```bash
cd backend
wrangler d1 migrations apply local-db --local --file drizzle/migrations/<your_file>.sql
```

Note: prefer applying in order unless you have a specific need and understand dependencies.

5. Regenerating from scratch (local only)
   If your local DB needs a reset during development:

```bash
cd backend
wrangler d1 execute local-db --local --file drizzle/migrations/meta/0000_snapshot.json | cat
```

Or delete the local SQLite storage (if using `persist = true`) and re-apply migrations. Use with caution.

### Naming conventions and best practices

- Commit both SQL and the `meta/` journal files generated by Drizzle.
- Keep migration files atomic and descriptive (Drizzle auto-names; optionally add context in commit message).
- Avoid manual editing of generated SQL unless necessary; if edited, keep the SQL idempotent where possible.
- For destructive changes (DROP COLUMN/TABLE), prefer a two-step rollout: add new column → backfill → switch over → drop old.
- When adding NOT NULL columns, provide defaults to avoid failing on existing rows.

### CI/CD notes

- In production, use Wrangler to apply migrations before deploying code that depends on them.
- Ensure `wrangler.toml` has the right D1 database bindings and `migrations_dir` (already set to `drizzle/migrations`).

### Troubleshooting

- If `db:generate` produces no files, ensure `backend/drizzle.config.ts` schema path points to `./drizzle/schema/index.ts` and `backend/tsconfig.json` includes `drizzle/**/*.ts`.
- If Wrangler can’t find migrations, confirm `migrations_dir` in `backend/wrangler.toml` is `drizzle/migrations`.
- For type errors, run `yarn --cwd backend typecheck`.
